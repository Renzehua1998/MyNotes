# 第六章 链路层和局域网

——广域网也有链路层，但是相对来说比较简单，所以重点放在局域网

——由一个节点如何到达另外一个相邻节点：点到点传输

目标：

- 原理：检错和纠错、共享广播信道（多点接入）、链路层寻址、LAN、可靠数据传输（Rdt、流量控制-讲过了）
- 实现：PPP、802.3、802.11

网络节点的连接方式：

- 点到点连接：广域网（物理限制、带宽延迟大-碰撞损失极大）——不用考虑寻址、访问控制
- 多点连接（共享介质、交换机AP）：局域网——多点访问控制（MAC）、寻址

## 6.1 引论和服务

**术语规范**：

1. 节点nodes：主机和路由器
2. 链路links：连接个相邻节点通信信道（有线无线）
3. 帧frame：链路层的PDU

——数据链路层负责从一个节点通过链路将（帧中的）数据报发送到相邻的物理节点

**上下文**：（类比与一个人乘坐不同的交通工具）

- 数据报（分组）在不同的链路上以不同的链路协议传送
- 不同的链路协议提供不同的服务

**链路层服务**：

- 成帧、链路接入：打包、获得信道使用权——使用“MAC”（物理）地址来标示源和目的
- 相邻两点间完成可靠数据传输：有些有，有些没有（本身可靠就不用、本身不可靠就必须进行差错控制）
- 流量控制、错误检测、差错纠正、半双工和全双工

**在哪里实现**？

——每台主机上的**网卡**（网络适配器、网络接口卡、NIC）：链路层+物理层。硬件、软件和固件的综合体

**适配器通信**：同时可以发可以接

- 发送方：封装、差错控制、发出去
- 接收方：监听、接收、检错、解封装

## 6.2 差错检测和纠正

EDC——差错控制编码，存在残存错误；D——被保护的数据内容

**校验方法**

- **奇偶校验**：一维、二维（可以定位出错位置）：对偶情况也可能检测不到。

- **校验和**：1的补码和，循环相加

- **CRC**（循环冗余校验）：

**CRC**：

1. **模2运算**——加法不进位、减法不借位（其实就是**按位异或**）
2. 位串的两种表示—— $x^3+x^1+1=1011$
3. **生成多项式**G——r次方的一个多项式表示一个比特序列：r+1位
4. 生成r位冗余位，使得**数据位+冗余位刚好能被生成多项式整除**。

$D·2^r\ XOR\ R = nG$ 两边再异或R，等价于：$D.2^r = nG\ XOR\ R $ 。——两边同除G，得到的余数就是 R

**计算R**：D左移R位除以生成多项式得到余数（不足R位补0）即为EDC，接收方判断能否整除即可。

**CRC性能分析**：（理论分析不要求掌握）

- 能够检查出所有的1bit错误
- 能够检查出所有的双bits的错误
- 能够检查出所有长度 =r或者<r 位的错误
- 长度为 r+1的突发错误，检查不出的概率是：$1/2^{r-1}$
- 长度大于r+1的突发错误，检查不出的概率：$1/2^{r}$

## 6.3 多点访问协议

### 概述

两种类型链路：点对点、多点连接

多路访问协议存在的问题：2个或更多站点同时传送: **冲突（collision）**

介质访问控制协议：MAC-算法角度（MAP-协议角度）

- 分布式算法-决定节点什么时候可以发送
- 共享控制的通信必须用借助信道本身传输

**理想**MAC协议**特性**：

1. 一个节点占用所有带宽
2. M个节点占用R/M带宽
3. 完全分布式，没有统一协调节点
4. 简单易行

**分类**：

1. 信道划分：分路复用
2. 随机访问：允许冲突，可以解决冲突
3. 依次轮流：有中心节点控制、令牌

### 信道划分MAC协议

略（通信知识）

1. TDMA：时分多路
2. FDMA：频分多路
3. CDMA：码分多路——第三代移动通信技术（过时了）

### 随机存取协议

- 有数据要发送时，全部带宽发送
- 多节点同时传输，冲突检测恢复
- 随机MAC协议：
  1. 时隙ALOHA
  2. ALOHA
  3. CSMA：**CSMA/CD**, **CSMA/CA** 重点！——载波侦听、多路访问

1. **时隙ALOHA**

   每个时隙可发送一帧，每个节点都可以检测到是否产生了冲突，每一个随后的时隙以概率p重传帧直到成功。延迟没有上限，无法保证最长时间。

   **优点**：简单、全速率传播、完全分布式

   **缺点**：存在空闲时隙、冲突浪费时隙、检测冲突时间小于完全发完时间、需要同步

   **效率分析**：一个节点成功传输概率是$p(1-p)^{N-1}$，任何一个节点的成功概率是$Np(1-p)^{N-1}$。求导求极值，f(p*)=37.5%——信道利用率37%

2. **纯ALOHA**

   有帧马上传输，碰撞就不发，其他和时隙ALOHA一样

   **效率分析**：任何一个节点的成功概率是$Np(1-p)^{2(N-1)}$，f(p*)=17.5%——信道利用率17%，更差了。

3. **CSMA**(载波侦听多路访问)——发之前听一听有没有人在发

   ——冲突仍然有可能发生，两个节点可能侦听不到正在进行的传输（信道延迟造成的**延迟**）。延迟越大，冲突发生的概率越大。

#### CSMA/CD(冲突检测)

——事前侦听，边说边听（**先听后发，边听边发**）

- 冲突发生时则传输终止，减少对信道的浪费
- 有线局域网中容易实现，通过检测信号强度判断是否冲突

**以太网CSMA/CD算法**：

1. 将数据报生**成帧**
2. **侦听信道CS**——闲，直接发；忙，等待闲再发
3. 发送过程中不断**检测冲突CD**——没有冲突，成功；有冲突，停止之后重发
4. 检测到冲突后，发送一个**Jam信号**。**强化冲突**：让所有站点都知道冲突，所有监测到冲突节点都发送。
5. 放弃，适配器进入指数退避状态——**二进制指数退避算法**，窗口每次加倍，碰撞概率减半，等待时间变大。在第m次失败后，适配器随机选择一个$\{0，1，2，...， 2^{m-1}\}$中K，等待K*512位时，然后转到步骤2。对载荷自适应，载荷越大，碰撞概率高，动态加倍等待时间，取一个可用的平均等待时间，**动态分布式自适应算法**。

- 高负载：重传窗口时间大，减少冲突，但等待时间长 

- 低负载：使得各站点等待时间少，但冲突概率大

$$
efficiency=\frac 1 {1+5t_{prop}/t_{trans}}
$$

比ALOHA更好的**性能**，而且**简单，廉价，分布式**

#### 无线局域网 CSMA/CA（冲突避免）

WLAN两种模式：**有基础设施**、自组织，我们探讨前一种模式

基础设施：AP（access point 接入点-基站）、无线链路、（移动主机节点-非基础设施）

——无限介质有衰减、干扰、噪声，无法使用原来的冲突检测方式。

此情景下的冲突：2+ 站点（AP或者站点）在同一个时刻发送。

**802.11协议CSMA/CA算法**：

- 发送前**侦听**信道（CSMA）

- **不做冲突检测**，因为收到自己的电磁波信号远大于对方冲突信号。
  - 且冲突也可能成功，不冲突也不一定成功。
  - 例子：存在隐藏站点，暴露在两个传播范围的终端冲突也可以成功。

- 发送方：
  1. 侦听信道持续一段时间**空闲，直接发**。确认帧的等待空闲要比数据帧小（确认帧优先级高）
  2. 侦听信道**忙，随机选一个值**，**信道空闲时每次减一**，到0时发送帧，等待ACK。没收到ACK继续重复2。

- 接收方：
  - 如果帧正确，则在**SIFS后发送ACK**

为什么空闲还要等？——避免前一个发完以后**所有要发送的设备同时发，造成冲突**，减小信道利用率（**事前避免**）

——无法完全避免冲突：相互隐藏、非常近的随机值

发送方“**预约**”信道（可选项）

1. 发送方发送RTS（预约帧）
2. BS（AP）发送CTS广播，告诉其他所有设备信道被预约

#### 线缆接入网络

——特殊的random方式（下发存在集中控制，上行随机预约）

- 每个用户通过cable modem接入网络
- 分为上行、下行，分多个信道，由CMTS管理
- **下行**(广播)信道,FDM，互联网占一个（**不存在竞争**，用户根据地址接收），其余是广播、电视
- **上行**信道,FDM，进一步TDM分成**微时隙**：一部分是**竞争式（预约）**、一部分是**分配式**。
- 上行预约、下行发布预约结果，没预约上的话重新预约即可（类似于抢票）。或者之间分配好用就行。
- 预约产生碰撞，都无法使用，通过下行反映，二进制指数退避方法处理。

### 轮流MAC协议

**对比信道划分、随机存取**：信道划分低负载时利用率低，随机存取高负载时利用率低（反复碰撞）

——Taking Turns 低负载也很好，高负载也很好，但是太复杂很少使用。有**集中式、分布式**两种。

1. **轮询**：主节点邀请从节点依次传送

   问题：

   - 单点故障问题
   - 轮询消耗带宽
   - 等待轮询消耗时间

2. **令牌传递**：控制令牌( token)循环从一个节点到下一个节点传递，有数据就把令牌变成数据帧，接收方收到后再发出去（可能发给多个设备），最终回到发送方——令牌报文：特殊的帧；分类：令牌环、令牌总线。

   问题：

   - 令牌消耗带宽
   - 令牌循环延迟
   - 单点故障——令牌丢了，复杂点生成令牌方式


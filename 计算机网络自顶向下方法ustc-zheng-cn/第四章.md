# 第四章 网络层：数据平面

前几章在网络边缘，进入网络核心部分。

1. 导论（数据平面、控制平面）
2. 路由器结构组成
3. IP协议（格式、分片重组、地址转换、IPv4、IPv6）
4. SDN情况下数据平面（流表匹配）

## 4.1 导论

——**数据平面**、控制平面

- 服务模型
- **转发和路由**——分别是数据平面和控制平面，分为传统方式和SDN方式（四种）
- 路由器工作原理
- 通用转发

——协议实例与实现

### 功能概述

**网络层服务**：

- 主机对之间传送段（封装的传输层TCP段UDP数据报）
- 封装、解封装
- 协议存在于每个主机和路由器，路由器检查所有IP数据报头部

**关键功能**：

1. 转发：输入接口转发到输出接口（局部功能）
2. 路由：选择路径到达目标主机（全局功能）——算法、协议

**数据平面、控制平面**：

- 数据平面：转发（依靠路由表）——本地。传统：地址+转发表；SDN：多个字段+流表。
- 控制平面：路由（生成路由表）——全局。传统：路由器中实现；SDN：远程的服务器实现。

传统方式仅依靠IP地址，SDN方式匹配流表依靠**一系列字段**（MAC、配置信息等），SDN除了**转发**还可以**阻止（block）、泛洪、修改**等。SDN厂家的网络控制服务器通过南翔接口算出来流表分配给每个主机。

**传统方式和SDN方式**：

- 传统方式：**路由器** **分布式**计算路由表（Per-router），**两个平面紧耦合**。——很难改运行逻辑。
- SDN方式：**分组交换机**通过南向接口收到网络服务器的**集中控制**，**两个平面分开**。——很好改、可编程。

SDN：软件定义网络（software defined network）

### 服务模型

**指标**：

- 单个数据报：可靠性、延迟。
- 数据报流：保序性、带宽、延迟差（jitter）。

下下页具体模型（这些指标为特定值时表示某种模型）

1. **best effort**（尽力而为）：全部无法保证——IP
2. CBR（恒定速率）——下面都是ATM
3. VBR（变化速率）
4. ABR（可用比特率）
5. UBR（不指名比特率）

### 连接建立

某些架构中有连接（和传输层面向连接区别——连接还体现在交换路径上），如ATM等。

IP无连接建立的功能。

网络层和传输层连接服务区别：

- 网络层: 在2个主机之间，涉及到路径上的一些路由器
- 传输层: 在2个进程之间，很可能只体现在端系统上

## 4.2 路由器组成

### 结构概况

路由：**路由处理器**（运行路由实体软件）产生路由表

转发：**输入端口、输出端口、交换机**（根据路由表局部转发）——真实路由器端口既可以输入也可以输出

每个路由器设备涉及三层的数据：物理层、数据链路层、网络层。最多拆分到网络层。

### 输入端口

- 物理层：物理信号转换成数字信号；
- 数据链路层：检测帧头帧尾，检测是否出错，提取目标mac，一致则收取，把帧交给网络层实体；
- 网络层实体排队，根据路由表，排到队头根据目标IP转发到对应主机。（SDN则查流表，执行对应操作）

为转发**地址空间进行划分**，不同地址空间转发到不同的端口。采用**最长地址前缀匹配**的目标地址表项。

一般使用TCAMs( ternary content addressable memories)硬件实现，在IP匹配时也总使用。

- 可以在**一个时钟周期**内检索出地址，不管表空间有多大
- Cisco Catalyst系列路由器在TCAM中可以存储多达约为**1百万条**路由表项

### 交换结构

——switch fabric

存在**队列缓冲的原因**：存在头部阻塞（Head-of-the-Line (HOL) blocking）如多入一出，匹配输入输出速率瞬时不一致性。

局部交换速率要**n倍于发送速率**（n为输入输出端口个数）

三种**典型交换结构**：

1. **基于memory（内存）**：第一代，拷贝到系统内存头部提取出目标地址，查找转发表，找到对应的输出端口，拷贝到输出端口。——经过两次系统总线，收到内存带宽限制，一次只能转发一个分组。
2. **基于bus（总线）**：此总线不是系统总线，而是switch fabric。——收到总线带宽限制，一次处理一个分组，对于企业网、接入网速度完全够。
3. **基于crossbar（互联网络）**：Banyan（榕树）网络，crossbar(纵横)和其它的互联网络（不同于互联网！）。每次把不同两根线之间短路即可随时接通。可以把分组切开，通过网络时间固定，便于调度。——克服总线带宽限制，对于骨干网来说常使用。

### 输出端口

- 物理层：把链路层的数据变成物理信号打出去；
- 链路层：帧封装，加帧头帧尾，校验等等功能；
- 网络层：排队，排到队头转发，交给链路层网卡。

存在**缓存队列原因**：交换结构速度和输出端口瞬时速度不一致。溢出则会被抛弃掉。

存在**调度规则**，不一定先来的先发（保证对某些应用服务质量的支持）。

缓存**建议规则**（自己看）：拇指规则等。

**调度机制：**

1. **FIFO** (first in first out)**先到先出**

   丢弃策略：

   - tail drop：丢弃刚到达的分组
   - priority：根据优先权丢失/移除分组
   - random：随机地丢弃/移除

2. **优先权调度**：多类，不同类别有不同的优先权。先传高优先级的队列中的分组

3. **Round Robin** (RR)：循环所有类，公平轮换。
4. **Weighted Fair Queuing** (WFQ)：每种分组享用不同权重的优先级占比。

## 4.3 IP: Internet Protocol